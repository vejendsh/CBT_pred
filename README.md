# Core Body Temperature Prediction (CBT_pred)

The code in this repository can be used to train a machine learning-based surrogate model that can forecast how a person’s Core Body Temperature (CBT) will evolve over the next 60 minutes in different thermal environments.

CFD data was used to train the surrogate model which was generated using ANSYS Fluent 2024 R1. The generation of CFD data and its preprocessing, training of the surrogate model, and evaluation of its performance is handled.

---
## Table of Contents
1. Project Overview
2. Repository Structure
3. Quick Start
4. Detailed Workflow
   1. Parameter Sampling & CFD Case Generation
   2. Data Pre-processing
   3. Model Definition
   4. Training & Evaluation
5. Utilities
6. Results & Visualisations
7. Contributing
8. License

---
## 1. Project Overview
Predicting the Core Body Temperature of humans in different thermal environments through traditional CFD computations is time consuming. This makes them infeasible for workplace heat-injury prevention in frontline workers exposed to extreme temperatures. However, the CFD data can be used to train surrogate models which learn the relationship in the data and predict Core Body Temperature orders of magnitude faster. Such surrogate models can be useful in workplace health monitoring and effecive heat-injury prevention. To create such a surrogate model, we: 
1. Use **Ansys Fluent 2024 R1** to perform thousands of CFD computations to predict Core Body Temperature profiles of humans of different physiologies exposed to different thermal conditions.
2. Collect the data - consists of Core Body Temperature profiles of thousands of different humans with different metabolic rates of head, muscle, and internal organs; exposed to different thermal conditions characterized by different ambient temperatures and heat transfer coefficients - and compress them into tensors. 
3. Train a fully-connected neural network to map the 5-dimensional input parameter vector (metabolic rate of head, muscle, internal organs, ambient temperature, and heat transfer coefficient) → 100-point discretized core body temperature profile (via FFT domain).

Once trained, inference takes milliseconds on CPU/GPU without invoking Fluent.

---
## 2. Repository Structure
```
CBT_pred/
├── cases/                   # Raw & generated Fluent case/result files
│   └── exercise/with_sweating/case_1/
│       ├── change_parameter.log          # Journal to modify case parameters
│       ├── steady_and_transient.log      # Journal to run the case
│       ├── Exercise_Case_SteadyState.cas.h5   # Baseline case
│       └── *.dat.h5 / *.out              # Generated by solver sessions
│
├── src/                     # All Python sources
│   ├── config.py            # Global path configuration
│   ├── solver/
│   │   └── solver.py        # Launches Fluent, updates journals, batches cases
│   ├── data_preprocessing/
│   │   └── data_preprocessor.py # Reads case files, builds tensors, normalises
│   ├── model/
│   │   └── model.py         # `NeuralNetwork` architecture
│   ├── training/
│   │   └── training.py      # Dataset class, training loop, metrics & plots
│   └── utils/
│       ├── parameters.py    # Random Latin-Hypercube-like sampling of inputs
│       └── utils.py         # Normalisation, tensor I/O, misc helpers
│
└── README.md
```

---
## 3. Quick Start
### Prerequisites
* Python ≥ 3.9
* [PyTorch](https://pytorch.org/) with CUDA (optional but recommended)
* [Ansys Fluent 2023-R1](https://www.ansys.com/) + **pyfluent** package
* Git, pip

```bash
# Clone repo
$ git clone https://github.com/your_org/CBT_pred.git && cd CBT_pred

# Create & activate virtualenv (recommended)
$ python -m venv .venv && source .venv/Scripts/activate  # Windows PowerShell: .venv\Scripts\Activate.ps1

# Install Python dependencies
$ pip install -r requirements.txt   # see section below if file is not present yet
```
---
## 4. Detailed Workflow
### 4.1 Parameter Sampling & CFD Case Generation (`src/utils/parameters.py`, `src/solver/solver.py`)
* `parameters.py` randomly samples **4000** points in the 5-D input space and stores them in `dataset_dict`.
* `solver.py` loops over these points:
  1. Edits `change_parameter.log` to inject new values.
  2. Runs `steady_and_transient.log` inside a Fluent session.
  3. Saves the converged case file as `Exercise_Case_SteadyState_i.cas.h5`.

### 4.2 Data Pre-processing (`src/data_preprocessing/data_preprocessor.py`)
* Scans the `Run_*` folders produced by Fluent.
* Extracts the last five input parameters from each case header (`CaseFile.input_parameters()`)
* Reads core-temperature `report-def*.out` files and stacks them into a `[N,100]` tensor.
* Saves normalised tensors to disk (`input_data_*.pt`, `output_*.pt`).

### 4.3 Model Definition (`src/model/model.py`)
A fully-connected network:
```
5 → 32 → 64 → 128 → 256 → 256 → 256 → 128 → 64 → 32 → 102
```
with `tanh` activations.  The 102 outputs represent the real & imaginary FFT coefficients of a 100-point time series.

### 4.4 Training & Evaluation (`src/training/training.py`)
* Wraps tensors in a `CBTDataset` and `DataLoader`.
* Loss = MSE (optionally a custom weighted loss).
* `ReduceLROnPlateau` scheduler adapts LR.
* `wandb` logging optional.
* `compare()` helper visualises 80 random test curves vs predictions.
* `mse()` computes MSE, MAE, Pearson r, and R² across the test set.

---
## 5. Utilities
`src/utils/utils.py` provides:
* `save_tensor_to_file` – convenient overwrite-aware saving.
* `min_max_normalize`, `z_score_normalize` – tensor normalisation helpers.
* `sort_case_file`, `sort_core_temp_file` – natural sorting of file names.
* `CustomLoss` – an example composite loss.

---
## 6. Results & Visualisations
Training metrics and comparison plots can be found in the `wandb` run (if enabled) or generated locally via `compare()`.

---
## 7. Contributing
1. Fork & clone.
2. Create a feature branch.
3. Commit descriptive messages.
4. Submit a Pull Request.

Please adhere to [PEP 8](https://pep8.org/) and format with `black`.

---
## 8. License
Distributed under the MIT License.  See `LICENSE` for details. 
